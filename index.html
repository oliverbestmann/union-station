<!DOCTYPE html>

<style>
    html, body {
        padding: 0;
        margin: 0;

        background: black;
    }

    #Loader {
        display: grid;
        place-content: center;
        height: 100dvh;
        width: 100dvw;

        color: #dbcfb1;

        font-family: "CoinageCapsKrugerGray", serif;
        font-size: 24px;
        font-weight: bold;

        text-align: center;

        line-height: 120%;
    }

    #Progress {
        font-size: 16px;
    }


    @font-face {
        font-family: "CoinageCapsKrugerGray";
        src: local("CoinageCapsKrugerGray"), url("assets/CoinageCapsKrugerGray.ttf") format("truetype");
        font-display: block;
    }
</style>

<div id="Loader">
    <div>Loading game&hellip;</div>
    <div id="Progress">&nbsp;</div>
</div>

<script src="wasm_exec.js"></script>

<script>
    window.Player = null;

    window.GetPlayer = function GetPlayer(candidate) {
        try {
            const name = window.Player ?? localStorage.getItem("union-station.Player") ?? candidate;
            localStorage.setItem("union-station.Player", name)
            return name
            
        } catch (_err) {
            return candidate
        }
    }
</script>

<script>
    // setup polyfill for requestIdleCallback
    if (!window.requestIdleCallback) {
        window.requestIdleCallback = function (cb) {
            const start = Date.now();
            return setTimeout(() => cb({
                didTimeout: false,
                timeRemaining: function () {
                    return Math.max(0, 50 - (Date.now() - start));
                },
            }), 1);
        };

        window.cancelIdleCallback = function (id) {
            clearTimeout(id);
        };
    }

    const observer = new MutationObserver(events => {
        for (const event of events) {
            for (const node of event.addedNodes) {
                if (node.nodeName.toLowerCase() === "canvas") {
                    document.querySelector("#Loader").remove();
                    observer.disconnect();
                }
            }
        }
    });

    observer.observe(document.body, {childList: true});

    const response = fetch("unionstation.wasm").then(response => {
        let loaded = 0
        const size = (response.headers.get('Content-Length') ?? response.headers.get("x-goog-stored-content-length")) | 0;

        const progressNode = document.querySelector("#Progress");

        const progress = new TransformStream({
            transform(chunk, controller) {
                loaded += chunk.length;
                controller.enqueue(chunk);

                if (size > 0) {
                    progressNode.innerText = ((loaded / 1024) | 0) + "kb out of " + ((size / 1024) | 0) + "kb";
                }
            }
        });

        const body = response.body.pipeThrough(progress);

        const patched = new Response(body, {
            status: response.status,
            statusText: response.statusText,
        });

        // Make sure to copy the headers!
        // Wasm is very picky with it's headers and it will fail to compile if they are not
        // specified correctly.
        for (var pair of response.headers.entries()) {
            patched.headers.set(pair[0], pair[1]);
        }

        return patched;
    });

    const go = new Go();
    WebAssembly.instantiateStreaming(response, go.importObject).then(result => {
        go.run(result.instance);
    });
</script>
